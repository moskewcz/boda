CUCL_GLOBAL_KERNEL void %(rtc_func_name)( GASQ float const * const in, // CUCL IN img:chan:y:x
					  GASQ float * const out, // CUCL OUT img:chan:y:x
					  GASQ float * const out_in_yx ) // CUCL OUT img:chan:y:x
// note: out_in_yx will be NULL+unused if emit_out_in_yx is 0; otherwise it will be non-null and used.
// note: emit_out_in_yx will only be non-zero when avg_pool==0, as it's not sensible otherwise
/* kern_sz */  // CUCL REF y:x
/* in_pad */  // CUCL REF y:x
/* stride */  // CUCL REF y:x
{
  // CUCL IX GLOB_ID_1D out
  if( GLOB_ID_1D >= %(GLOB_ID_1D_dims_prod) ) { return; }
  float out_v = 0.0f;
  int oyx = -1; // invalid value, will prevent propogation of this output's gradient
  for( int32_t kx = 0; kx != %(kern_sz_x_dim); ++kx ) {
    for( int32_t ky = 0; ky != %(kern_sz_y_dim); ++ky ) {
      float v = 0;
      int const in_y = %(GLOB_ID_1D_y)*%(stride_y_dim) + ky - %(in_pad_y_dim);
      int const in_x = %(GLOB_ID_1D_x)*%(stride_x_dim) + kx - %(in_pad_x_dim);
      if(in_y >= 0 && in_x >= 0 && in_x < %(in_x_dim) && in_y < %(in_y_dim) ) {
	int32_t const in_ix = %(GLOB_ID_1D_img)*%(in_img_sz) + %(GLOB_ID_1D_chan)*%(in_chan_sz) + 
	  in_y*%(in_y_sz) + in_x*%(in_x_sz);
	v = in[in_ix];
	if( %(emit_out_in_yx) ) { if ( v > out_v ) { oyx = in_y*%(in_x_dim) + in_x; } } // propogate to (only) this input
      }
      if( %(avg_pool) ) { out_v += v; } else {
	out_v = max( out_v, v ); 
      }
    }
  }
  // FIXME: the scaling factor for the avg_pool=1 case should only include the # of pixels that were averaged over, not
  // the entire kernel size. to agree with caffe, this should include padding pixels but *NOT* truncated pixels. this
  // distinction is only important if the stride is >1 and such that the output includes a pixel that uses a
  // clipped/truncated input region (i.e. that extends outside padding). see the details of the pooling output size
  // calculation for details.
  if( %(avg_pool) ) { out_v /= (float)(%(kern_sz_x_dim)*%(kern_sz_y_dim)); }
  out[GLOB_ID_1D] = out_v;
  if( %(emit_out_in_yx) ) { out_in_yx[GLOB_ID_1D] = oyx; }
}
